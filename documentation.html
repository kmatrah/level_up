<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html"
      xmlns="http://www.w3.org/1999/html"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>LevelUp - Documentation</title>
<meta name="viewport" content="width=device-width">
<link type="text/css" rel="stylesheet" href="stylesheets/reset.css">
<link type="text/css" rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/js/google-code-prettify/prettify.css">
<link type="text/css" rel="stylesheet" href="stylesheets/documentation.css">

<script src="javascripts/jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/google-code-prettify/prettify.js" type="text/javascript"></script>

<!-- html5.js for IE less than 9 -->
<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<!-- css3-mediaqueries.js for IE less than 9 -->
<!--[if lt IE 9]>
	<script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
<![endif]-->

</head>
<body>

<header>
  <div class="top-bar"></div>
</header>

<div id="menu">
  <nav>
    <dl>
      <dt><a href="#introduction">Introduction</a></dt>
      <dd><a href="#what">What is it?</a></dd>
      <dd><a href="#why">Why use graphs?</a></dd>

      <dt><a href="#getting-started">Getting Started</a></dt>
      <dd><a href="#include">Including LevelUp</a></dd>
      <dd><a href="#migrations">Running migrations</a></dd>
      <dd><a href="#mounting">Mounting the engine</a></dd>
      <dd><a href="#authentication">Authentication</a></dd>

      <dt><a href="#core-concepts">Core Concepts</a></dt>
      <dd><a href="#jobs">Jobs</a></dd>
      <dd><a href="#tasks">Tasks</a></dd>
      <dd><a href="#transitions">Transitions</a></dd>
      <dd><a href="#timers">Timers</a></dd>
      <dd><a href="#manual-tasks">Manual Tasks</a></dd>
      <dd><a href="#errors">Errors</a></dd>
      <dd><a href="#work-queue">Work Queue</a></dd>


      <dt><a href="#job-models">Job Models</a></dt>
      <dd><a href="#tasks-transitions">Tasks & Transitions</a></dd>
      <dd><a href="#task-methods">Task Methods</a></dd>
      <dd><a href="#task-classes">Task Classes</a></dd>
      <dd><a href="#flow-control">Flow Control</a></dd>

      <dt><a href="#running-jobs">Running Jobs</a></dt>
      <dd><a href="#synchronously">Running synchronously</a></dd>
      <dd><a href="#asynchronously">Running asynchronously</a></dd>

      <dt><a href="#jobs-statuses">Jobs Statuses</a></dt>
      <dd><a href="#queued">Queued</a></dd>
      <dd><a href="#timer">Timer</a></dd>
      <dd><a href="#manual-task">Manual Task</a></dd>
      <dd><a href="#error">Error</a></dd>
    </dl>
  </nav>
</div>

<div id="content">
  <h1>Level<em>Up</em> Documentation</h1>
  <h2>Everything you need to know to build jobs using LevelUp</h2>
  <p id="warning">Warning: this documentation is still being written. You can send feedback via email or via Github Issues.</p>

  <section>
    <h3 id="introduction">Introduction</h3>

    <h4 id="what">&raquo; What is it?</h4>
    <p>
      If you are building a web app, chances are good you have some jobs to design and execute in order to provide services to your customers.
      Generally, that means handling computer-based or manual tasks, calls to external services, failures, timers and retries.
      LevelUp lets you build all of these and compose them to create a runnable job. Concretely, you will define a task graph, where each task contains its own business
      logic implemented in ruby. Jobs can be performed synchronously in the current thread or asynchronously by background workers.
      Three methods are available in each state to control the job flow: move_to!(task_name), retry_in!(delay), manual_task!(task_description).
    </p>

    <h4 id="why">&raquo; Why use graphs?</h4>
    <p>
      Designing your jobs graphically with tasks and transitions can be more easier than directly writing code, especially for non-technical people.
      Graphs can be drawn, printed, shared and analysed making it easier to let everyone know what the system is doing at specific points in time.
      From a developers point of view, itâ€™s clearer to separate the different parts of a job into isolated tasks. Class-based tasks are reusable in multiple jobs
      to avoid code duplication. For example, you can use the Template design pattern to implement the generic part of a task in a parent class and implement
      specialized parts in children classes.
    </p>
  </section>

  <section>
    <h3 id="getting-started">Getting Started</h3>

    <h4 id="include">&raquo; Including LevelUp</h4>
    <p>Add LevelUp to your Gemfile:</p>
    <pre class="prettyprint lang-ruby">gem 'level_up'</pre>
    <p>and run <b>bundle install</b> within your app's directory.</p>

    <h4 id="migrations">&raquo; Running Migrations</h4>
    <p>First, make sure DelayedJob migration is installed. If not:</p>
    <pre class="prettyprint lang-bash">$ rails g delayed_job:active_record</pre>
    <p>Install and run LevelUp migration:</p>
    <pre class="prettyprint lang-bash">
$ rake level_up:install:migrations
$ rake db:migrate</pre>

    <h4 id="mounting">&raquo; Mounting the engine</h4>
    <p>In your routes file:</p>
    <pre class="prettyprint lang-ruby">
# config/routes.rb
Rails.application.routes.draw do
  mount LevelUp::Engine => "/level_up"
  # other routes ...
end</pre>

    <h4 id="authentication">&raquo; Authentication</h4>
    <p>
      LevelUp only provide basic http authentication through Rails 3.1+ <em>http_basic_authenticate_with</em> method. Authentication is disabled by
      default. To enable it, add these lines in your config/environments/*.rb.
    </p>
    <pre class="prettyprint lang-ruby">
config.level_up.http_authentication = true
config.level_up.http_login = "your-login"
config.level_up.http_password = "your-password"</pre>

  </section>

  <section>
    <h3 id="core-concepts">Core Concepts</h3>

    <h4 id="jobs">&raquo; Jobs</h4>
    <p>Being written.</p>

    <h4 id="tasks">&raquo; Tasks</h4>
    <p>Being written.</p>

    <h4 id="transitions">&raquo; Transitions</h4>
    <p>Being written.</p>

    <h4 id="timers">&raquo; Timers</h4>
    <p>Being written.</p>

    <h4 id="manual-tasks">&raquo; Manual Tasks</h4>
    <p>Being written.</p>

    <h4 id="errors">&raquo; Errors</h4>
    <p>Being written.</p>

    <h4 id="work-queue">&raquo; Work Queue</h4>
    <p>Being written.</p>
  </section>

  <section>
    <h3 id="job-models">Job Models</h3>
    <h4 id="tasks-transitions">&raquo; Tasks & Transitions</h4>
    <pre class="prettyprint lang-ruby">
# app/models/hard_job.rb
class HardJob < LevelUp::Job
  # tasks and transitions
  job do
    # you must declare a transition from the 'start' state
    task :start, transitions: :first_task

    # 'first_task' declaration with one transition to 'second_task'
    task :first_task, transitions: :second_task

    # 'second_task' declaration with two transitions
    task :second_task, transitions: [:third_task, :another_task]

    # you must declare a transition to the 'end' state
    task :third_task, transitions: :end
    task :another_task, transitions: :end
  end
end</pre>
    <h4 id="task-methods">&raquo; Task Methods</h4>
    <pre class="prettyprint lang-ruby">
# app/models/hard_job.rb
class HardJob < LevelUp::Job
  job do
    # ...
  end

  # task definition through methods

  def first_task
    # 'first_task' state logic goes here
  end

  def second_task
    # 'second_task' state logic goes here
  end

  def third_task
    # 'third_task' state logic goes here
  end

  def another_task
    # 'another_task' state logic goes here
  end
end</pre>
    <h4 id="task-classes">&raquo; State Classes</h4>
    <p>You can also define task logic in a class instead of a method:</p>
    <pre class="prettyprint lang-ruby">
# app/models/hard_job/first_task.rb
module HardJob
  class FirstTask < LevelUp::Task
    def run
      # 'first_task' state logic goes here
    end
  end
end</pre>
    <h4 id="flow-control">&raquo; Flow Control</h4>
    <p>Inside a task, you can call 3 methods to control the job flow.</p>
    <h5>+ move_to!(task_name)</h5>
    <p>Leave the current task and run the specified one:</p>
    <pre class="prettyprint lang-ruby">
def first_task
  # ...
  # at some point in 'first_task' task definition
  move_to! :second_task
end</pre>
    <h5>+ retry_in!(delay)</h5>
    <p>Stop the execution and queue a new delayed_job to re-run the current task after the specified delay in seconds:</p>
    <pre class="prettyprint lang-ruby">
def second_task
  # ...
  # at some point in 'second_task' task definition
  retry_in! 1.hour
end</pre>
    <h5>+ manual_task!(description)</h5>
    <p>Stop the execution and set the manual_task and manual_task_description attributes to notify that a manual human intervention is needed.</p>
    <pre class="prettyprint lang-ruby">
def third_task
  # ...
  # at some point in 'third_task' task definition
  manual_task! "task description goes here"
end</pre>
    <p>
      You can also raise a StandardError (or a subclass) to stop the execution and set the error attribute.
      The time, the task and the error backtrace will be saved.
    </p>
  </section>

  <section>
    <h3 id="running-jobs">Running Jobs</h3>
    <p>In your controllers, models or also in other jobs</p>
    <h4 id="synchronously">Running Synchronously</h4>
    <p>Execute the job synchronously in the current thread</p>
    <pre class="prettyprint lang-ruby">
sync_job = HardJob.create(key: "job-key")
sync_job.boot!</pre>
    <h4 id="asynchronously">Running Asynchronously</h4>
    <p>Execute the job asynchronously with a new delayed_job</p>
    <pre class="prettyprint lang-ruby">
async_job = HardJob.create(key: "job-key")
async_job.boot_async!</pre>
  </section>

  <section>
    <h3 id="job-statuses">Job Statuses</h3>
    <h4 id="queued">Queued</h4>
    <p>
      A job is considered as <em>queued</em> when it references a <em>delayed_job</em> in the queue ready to be consumed by a worker.
      This happens when you call the <em>boot_async!</em> method on a job.
    </p>
    <pre class="prettyprint lang-ruby">
job = HardJob.create(key: 'job-key')
job.boot_async!
# the job is now queued and ready to be consumed</pre>
    <h4 id="timer">Timer</h4>
    <p>
      The <em>timer</em> attribute indicates whether or not a <em>delayed_job</em> has been pushed into the queue to be consumed by a worker at a <em>specific time</em>.
      This happens when you call the <em>retry_in!(delay)</em> method inside a task. The <em>retry_at</em> attribute indicates the time when the job will be ready to be consumed.
      Before that time, you can manually remove the job from the queue calling its <em>unqueue!</em> method.
    </p>
    <pre class="prettyprint lang-ruby">
# remove the job from the queue before beeing consumed
job.unqueue!</pre>
    <h4 id="task">Task</h4>
    <p>
      The <em>manual_task</em> attribute indicates whether or not there is a <em>manual human task</em> to accomplish. The <em>manual_task_description</em> attribute provides details about
      what is expected to be done. Inherently, if the <em>manual_task</em> attribute is equal to <em>true</em>, there is no delayed_job in the queue.
      The job is suspended waiting for a human intervention. This happens when you call the <em>manual_task!(description)</em> method inside a task.
    </p>
    <h4 id="error">Error</h4>
    <p>
      The <em>error</em> attribute indicates whether or not an error has been raised and not rescued when running a task. In this case, the error is rescued at the job level.
      The <em>failed_in</em>, <em>failed_at</em> and <em>backtrace</em> attributes save the task where the error has been raised, the time and the first five elements of the backtrace error
      (the backtrace is serialized as an array of strings in the database).
    </p>
    <pre class="prettyprint lang-ruby">
class HardJob < LevelUp::Job
  job do
    # ...
  end

  def first_task
    # ...
    # an error is raised
    0 / 0
    # the error is rescue at the job level
    # failed_in => 'first_task'
    # failed_at => the the when the error has been raised
    # backtrace => ['ZeroDivisionError: divided by 0', ...]
  end
end</pre>
  </section>
</div>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-XXX-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  $(function() {
    prettyPrint();
  });
</script>

</body>
</html>
